:doctitle: Simplifier la création d'une PWA avec workbox.js
:description:  Description de la nouvelle toolbox Google workbox.js simplifiant la création de progressive webapp
:keywords: Web, PWA, ServiceWorker
:author: Guillaume EHRET - Dev-Mind
:revdate: 2017-06-15
:category: Web
:teaser: todo
:imgteaser: ../../img/blog/2017/ecrire_ses_scripts_gradle_en_kotlin_00.png

Si vous suivez l'actualité Dev-Mind (https://www.dev-mind.fr/formation_optimiser.html[formation] ou https://www.dev-mind.fr/experience.html#conferences[conférence] sur les performances web), j'ai introduit à plusieurs occasions le concept des progressive webaps et des service workers.

== Progressive Webapp et service worker

Revenons un peu à la base si vous ne connaissez pas ces termes.

* Les *progressive webapps* (PWA) sont un concept poussé par Google. Le but est de pousser les développeurs à créer des applications web moderne facilitant la navigation des utilisateurs. Les évolutions des standards du web font que les applications proposées au sein d'un navigateur se rapprochent de plus en plus de ce que l'on peut faire avec des applications natives. Une application web doit s'adapter aux tailles des écrans des utilisateurs, être rapide à charger, doit marcher quand le réseau est faible ou inexistant, doit pouvoir faire des notifications sur un téléphone...
* Les *services workers* sont un moyen technique pour arriver à mettre en place certains concepts d'une progressive webapp comme le fonctionnement hors ligne ou sur réseau défaillant. Il n'y a pas de magie les services workers permettent simplement de recharger les données déjà chargées et qui ont été persistées dans un cache local. Les services workers permettent de faire ce travail de l'ombre et de charger en tâche de fond les ressources dont vous avez besoin sur votre site et de les servir pour améliorer les performances ou lorsque vous n'avez pas de réseau.

Je vais revenir un peu plus en détail sur les services workers juste après mais il est important de savoir que toutes ses fonctionalités peuvent aujourd'hui être mises en place dans les navigateurs modernes.

image::../../img/blog/2017/workboxjs_01.png[Can I Use service worker]

Gros bémol pour Safari (navigateur Apple) qui traîne à implémenter les normes et qui est aujourd'hui le pire navigateur pour surfer sur le web. Mais ces nouvelles fonctionnalités peuvent tout de même être ajoutées à votre site. Elles ne s'activeront tout simplement pas sur les navigateurs à la traîne. Sur Edge ils ne sont pas encore actifs par défaut mais ça devrait arriver

== Les workers

Tous les navigateurs implémentent aujourd'hui l'API des web workers. Par défaut JavaScript est mono thread et tout s'exécute dans un thread principal. Bien évidemment si vous multipliez les traitements dans cet unique thread vous risquez d'avoir des problèmes de performance. L'api Web Worker permet de déporter des traitements dans un thread en arrière plan. Ce thread ne peut pas accéder à toutes les API. Par exemple vous ne pouvez pas manipuler le DOM mais vous pouvez utiliser d'autres API comme WebSocket, IndexedDB...

Les échanges entre un worker et votre thread principal ne peut se faire que par échange de message. Le mieux pour comprendre est de prendre un exemple. Voici comment éclarer un worker dans votre thread principal

[source, javascript, subs="none"]
----
// Création du worker
var worker = new Worker('doWork.js');

// On crée un event listener pour intercepter les messages envoyés par le worker
worker.addEventListener('message', (e) => {
   console.log('Worker said: ', e.data);
}, false);

// Vous pouvez à tout moment envoyé un message au worker
worker.postMessage('Hello World');
----

Au final le code du worker _doWork.js_ sera
[source, javascript, subs="none"]
----
// On crée un listener pour recevoir les messages du thread principal
self.addEventListener('message',(e) => {
   // la méthode postMessage permet de renvoyer un message
   self.postMessage(e.data);
}, false);
----

== Les services workers

Les services workers sont des workers. Il n'ont donc pas d'accès au DOM, et s'exécute dans une tâche de fond différente de celle du thread principal de votre application. Ils sont donc non-bloquants. Dans un web worker tout est asynchrone et le nombre d'API utilisable est plus restreint.

Un service worker peut être vu comme un proxy qui va se mettre entre votre site et le serveur et capable d'intercepter tous les requêtes qui rentrent et qui sortent pour les modifier. Les ressources prises en charge par le service worker sont définies dans un fichier de configuration JavaScript.

image::../../img/blog/2017/workboxjs_02.png[Service worker = proxy]

Plutôt sensible et critique non ? C'est pourquoi les services workers ne fonctionnent qu'en HTTPS. Le service worker vient avec un cache de ressources et comme à chaque fois avec les caches il faut être très vigilant. Si votre configuration est mauvaise vos utilisateurs ne recevront plus les mises à jour de vos ressources.



Un service worker fonctionne dans le contexte d'un worker : il n'a donc pas d'accès au DOM, et s'exécute dans une tâche différente de celle du script principal de votre application, ainsi il est non-bloquant. Il est conçu pour être totalement asynchrone; en conséquence, des APIs telles que XHR en synchrone et localStorage ne peuvent pas être utilisées au sein d'un service worker.

Les service workers fonctionnent uniquement sur HTTPS, pour des raisons de sécurité. Laisser des requêtes réseau modifiées sans défense face aux attaques de l'homme du milieu est une bien mauvaise chose.
Les boîtes à outils sw precache et sw-tool sont activement maintenues et nous prévoyons de continuer à les soutenir. Un grand nombre d'applications Web progressives de production les utilisent avec succès aujourd'hui et nous sommes heureux d'examiner des problèmes ou des relations publiques liés à l'un ou l'autre projet.

Parallèlement, nous travaillons sur la prochaine génération d'outils de Service Worker dans Workbox. Ce nouveau travail est plus modulaire et permettra à plusieurs bibliothèques de créer des capacités supplémentaires. Nous allons annoncer d'autres projets autour de la feuille de route pour ce travail à l'avenir.
Bien évidemment
A key part of fixing that is a programming movement called progressive web apps, or PWAs, that Google helped develop and that it's now promoting at its Google I/O developer conference. With PWAs, using the web can be a lot more like using a native app. Websites load fast, work even when there's no network connection, and notify you when a message arrives.

At the show, he's announcing three steps to try to make PWAs work better. Google's Workbox developer tool is designed to help programmers build PWAs, and its Lighthouse service to test those apps is now built directly into Chrome itself. Last, Google has finished Polymer 2.0, a collection of code that developers can use for a related technology called web components.

references
https://developers.google.com/web/tools/workbox/
https://workboxjs.org/#get-started
https://github.com/GoogleChrome/workbox