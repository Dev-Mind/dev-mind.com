:doctitle: Créer une application Android
:description: Eco-système Android
:keywords: Android
:author: Guillaume EHRET - Dev-Mind
:revdate: 2019-06-12
:category: Android
:teaser: todo
:imgteaser: :../../img/blog/2019/score_00.png
:toc:
J'ai donné plusieurs conférences sur https://www.android.com/[Android] en 2018 et 2019. Je vais revenir dans plusieurs articles sur le détail de ces conférences. Mon objectif est de vous montrer comment développer une application de A à Z en utilisant les dernières préconisations de Google. Dans cette première partie nous allons parler de l'écosystème Android et de la plateforme : chose essentielle si vous voulez comprendre les spécificités du développement Android.

== Ecosystème Android

=== Android l'OS le plus utilisé
Il y a deux acteurs majeurs dans le monde du mobile : Apple (https://www.apple.com/fr/ios/[IOs]) et Google (https://www.android.com/[Android]). Android est aujourd'hui l'OS sur mobile le plus utilisé dans le monde. Près de 70% des utilisateurs dans les pays occidentaux utilisent cette plateforme. En Afrique ou en Asie, la politique tarifaire d'Apple, fait que les parts de marché Android sont encore plus fortes et continuent à grimper.

.Répartition des OS mobiles (source statscounter 2019)
[caption=""]
image::../../img/blog/2019/android_eco_01.png[Répartition des OS mobiles]

Faire de la programmation mobile a un intérêt. L'accès à l'informatique (web ou autre) se fait de plus en plus avec des mobiles et tablettes. Android est devenu l'OS le plus utilisé au niveau mondial tout systême confondu

.Répartition mobile vs desktop (source statscounter 2019)
[caption=""]
image::../../img/blog/2019/android_eco_02.png[Desktop vs mobile]

.Répartition des OS (source statscounter 2019)
[caption=""]
image::../../img/blog/2019/android_eco_03.png[Répartition des OS]

=== Principe de la programmation mobile
La mobilité a transformé les devices que nous utilisons. Quand vous êtes sur un PC fixe ou un portable vous avez toujours a peu près les mêmes composants : CPU, carte graphique, disque dur, lecteur carte photo, ports d'entrée/sortie. Sur un mobile vous allez avoir plusieurs autres composants pour vous aider dans ce contexte de mobilité : GPS, caméra, appareil photo, accélomètre, podomètre... Nous avons de plus en plus de capteurs pour interpréter le contexte d'utilisation du device

.Capteurs des devices mobiles
[caption=""]
image::../../img/blog/2019/android_eco_04.png[Capteurs des devices mobiles]

La spécificité de la programmation mobile est de proposer des applications qui récupérent et aggrègent les données émises par les différents capteurs pour répondre à un besoin utilisateur. Quand vous voulez vous interfacer avec ces capteurs, apporter de la réactivité dans vos application, le développement natif est la solution.

Créer une application mobile pour simplement afficher du contenu statique n'a pas de sens. Pour ce besoin, on préférera les applications web responsives (PWA) qui sont beaucoup plus optimales et moins coûteuses. Une application native doit être dynamique et profiter des API exposées par les devices.

== Plateforme Android

Voici une image simplifiée de la plateforme Android

image::../../img/blog/2019/android_pf_01.png[Android se base sur Linux]

=== Noyau Linux
Android a été construit sur un https://www.kernel.org/[noyau Linux]. Mais Android n'est pas totalement Open Source. Seule une https://source.android.com/[partie] est libre de droit.

Android s'appuie sur les forces de Linux pour fournir un OS stable et fiable : gestion de la mémoire, gestion des processus, sécurité...

=== Couche d'abstraction hardware

Android définit une couche abstraite pour s'interfacer avec les différents capteurs ou élements de bas niveau d'un device :  HAL (Hardware Abstraction Layer). Les différents constructeurs de mobile doivent implémenter cette couche pour que leur téléphone puisse fonctionner. Ils doivent également prouver que leurs téléphones sont capables de répondre aux exigences de tests demandées par Google. Il existe des tests de compatibilités avec une version de l'OS (https://source.android.com/compatibility/cts[CTS compatibility test suite]) et des d'autres tests complémentaires (https://source.android.com/compatibility/vts[VTS Vendor test suite].

Ces développements peuvent être longs et coûteux. C'est pour cette raison, que les constructeurs ne font pas évoluer leur téléphone. Leur but est de vendre toujours plus de nouveaux devices, et non de maintenir les anciens. Ces problèmes de mises à jour entraînent une grosse fragmentation dans l'utilisation des versions de l'OS. Cette fragmentation liée aux versions de l'OS, est moins présente dans le monde IOs. Comme Apple est à la fois éditeur et constructeur, tout est fait pour que chaque nouvelle version soit supportée par les anciens devices.

=== Langages de programmation

Le coeur d'Android est écrit en http://www.open-std.org/jtc1/sc22/wg21/[C ou C++] et plusieurs librairies natives sont accessibles (https://developer.android.com/ndk/[NDK Native development kit]). Vous pouvez écrire vos applications en C mais pour faciliter la mise en place d'applications, Google a depuis les débuts poussés les développeurs à utiliser le langage Java. Ce dernier est parfois verbeux mais il a l'avantage d'être simple et d'amener un cadre de développement.

==== Machine virtuelle

Android propose donc une machine virtuelle pour exécuter du bytecode. Ce n'est pas une JVM classique. Les ingénieurs de chez Google ont essayé de travailler sur un bytecode avec une plus faible empreinte mémoire. En Android le compilateur va créer des fichier .dex (Dalvik executable). https://javamind-fr.blogspot.com/2012/10/dalvik-la-vm-android.html[Dalvik] était le premier compilateur utilisé sur la plateforme. Comme les JVM actuelles, Dalvik transformait le bytecode en langage machine à l'exécution : compilation Just In Time (JIT).

Aujourd'hui cette machine virtuelle a été remplacée par http://javamind-fr.blogspot.com/2014/06/art-nouvelle-machine-virtuelle-java.html[ART (Android Runtime)]. La transformation en langage machine est faite à l'installation de l'application : compilation AOT (ahead of time). Comme le bytecode est compilé plus tôt en langage machine, les applications se lancent plus vite et le CPU est moins solliciter lors de l'exécution (et donc préservation de votre batterie).

image::../../img/blog/2019/android_pf_02.png[Android compilation]

J'ai volontairement fait un abus de langage en indiquant que le bytecode était transformé en langage machine. Ce n'est pas vraiment le cas. Si nous avions vraiment du langage machine nous n'aurions plus besoin de VM. En fait à l'installation le bytecode est transformé en un format intermédiaire : fichiers .oat (ahead of time). La VM est nécessaire car elle va gérer les allocations mémoires et la libération de l'espace avec le Garbage collector. Même si la compilation n'est plus Just In Time, des optimisations sont toujours faites à l'exécution pour que le code s'exécute le plus vite possible.

Vous trouverez plus d'informations dans la https://source.android.com/devices/tech/dalvik/index.html[documentation].

Toutes ces adaptations par rapport à une machine virtuelle Java sont au coeur du procès entre Google et Oracle. Oracle n'a pas racheté Java à Sun pour se lancer dans l'Open Source. Ils l'ont surtout racheté en pensant faire payer des licences à Google pour chaque appareil vendus. Cette guerre commerciale est en train à mon sens de tuer l'utilisation de Java sur la plateforme. Mais pour une fois c'est aussi dans l'intérêt des développeurs car l'aspect financier a certainement été un catalyseur pour l'adoption de Kotlin.

==== Langage Kotlin

En 2017 une grande annonce a été faite à Google IO. Le langage https://kotlinlang.org/[Kotlin] devenait le deuxième langage de référence pour développer des applications. 2 ans après 50% des développeurs utilisent Kotlin et Google a https://android-developers.googleblog.com/2019/05/google-io-2019-empowering-developers-to-build-experiences-on-Android-Play.html[annoncé à Google I/O 2019] que la plateforme devenait Kotlin-first. Ils préconisent de démarrer les nouveaux développements en Java.

Si vous voulez en savoir plus sur le langage Kotlin et les avantages à l'utiliser sur la plateforme Android, vous pouvez lire https://dev-mind.fr/blog/2019/kotlin_et_android.html[mon article] sur le sujet.

==== Studio de développement

Initialement le studio de développement préconisé était Eclipse mais plus les fonctionnalités s'enrichissaient, plus l'IDE devenait inutilisable. Google a donc travaillé en partenariat avec https://www.jetbrains.com/[JetBrains] (éditeur de Webstorm ou IntelliJ) pour adapter leur version Open Source et créer https://developer.android.com/studio/[Android Studio].

Vous trouverez à l'intérieur de cet IDE toutes les fonctionnalités nécéssaires aux développements. Vous avez des utilitaires pour

* vérifier votre code
* gérer les différentes versions du SDK Android
* lancer un device virtuel sur votre machine pour tester manuellement ou automatiquement votre code
* packager votre application afin de la publier sur le store Google

=== Packager une application

belles images sur https://source.android.com/


https://developer.android.com/kotlin/learn

https://developer.android.com/kotlin/

https://www.jetbrains.com/
https://kotlinlang.org/docs/reference/comparison-to-java.html


 retrouve donc une machine virtuelle pour exécuter ce code Java

machine virtuelle ART est écrite avec ces librairies natives et plusieurs ponts sont faits également avec les API Java pour donner accès par exemple en Java à OpenGL. Vous pouvez programmer via Android NDK directement
La machine virtuelle Android Runtime permet d’exécuter les applications Java et Kotlin


